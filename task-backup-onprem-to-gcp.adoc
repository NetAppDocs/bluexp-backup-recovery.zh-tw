---
sidebar: sidebar 
permalink: task-backup-onprem-to-gcp.html 
keywords: backing up, back up, backup, backup on-prem ontap, on-premises, back up volumes, cloud backup, gcp, google cloud 
summary: 請完成幾個步驟、開始將內部部署 ONTAP 系統的大量資料備份到 Google 雲端儲存設備。 
---
= 將內部部署ONTAP 的內部資料備份到Google Cloud Storage
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
請完成幾個步驟、開始將內部部署 ONTAP 系統的大量資料備份到 Google 雲端儲存設備。

請注意、「內部部署ONTAP 的功能不只是指FAS 包含了功能不全的功能、AFF 包括了功能不全的功能、包括了功能不全的功能。ONTAP Select



== 快速入門

請依照下列步驟快速入門、或向下捲動至其餘部分以取得完整詳細資料。

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-1.png["一"] 確認您的組態支援
[role="quick-margin-list"]
* 您已探索內部部署叢集、並將其新增為藍圖XP中的工作環境。請參閱 https://docs.netapp.com/us-en/cloud-manager-ontap-onprem/task-discovering-ontap.html["探索 ONTAP 叢集"^] 以取得詳細資料。
+
** 叢集執行ONTAP 的是1.7P5或更新版本（ONTAP 建議使用更新版本的版本號為0。
** 叢集具有SnapMirror授權、包含在優質產品組合或資料保護產品組合中。
** 叢集必須具備所需的網路連線、才能連線至Google儲存設備和Connector。


* 連接器必須具備所需的網路連線、才能連線至Google儲存設備和叢集。
* 您擁有有效的Google訂閱、可用於存放備份的物件儲存空間。
* 您的Google帳戶擁有存取金鑰和秘密金鑰、ONTAP 因此該叢集可以備份及還原資料。


.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-2.png["二"] 在系統上啟用 BlueXP 備份與還原
[role="quick-margin-para"]
選取工作環境、然後按一下右窗格中「備份與還原」服務旁的*「啟用」>「備份磁碟區」*、再依照設定精靈進行。

[role="quick-margin-para"]
image:screenshot_backup_onprem_enable.png["螢幕擷取畫面顯示「啟用備份與還原」按鈕、可在您選取工作環境之後使用。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-3.png["三"] 選取雲端供應商、然後輸入供應商詳細資料
[role="quick-margin-para"]
選取Google Cloud做為供應商、然後輸入供應商詳細資料。您需要在ONTAP 駐留磁碟區的叢集中指定IPspace。您也可以選擇自己的客戶管理金鑰來進行資料加密、而非使用預設的Google管理加密金鑰。

[role="quick-margin-para"]
image:screenshot_backup_onprem_to_google.png["快照顯示雲端供應商將磁碟區從內部ONTAP 系統備份到Google Cloud Storage儲存庫時的詳細資料。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-4.png["四"] 定義預設備份原則
[role="quick-margin-para"]
預設原則會每天備份磁碟區、並保留每個磁碟區最近 30 個備份複本。變更為每小時、每日、每週、每月或每年備份、 或選取其中一個系統定義的原則、以提供更多選項。您也可以變更要保留的備份複本數量。

[role="quick-margin-para"]
根據預設、備份會儲存在標準儲存設備中。如果您的叢集使用ONTAP 的是更新版本的版本、您可以選擇在特定天數後將備份分層至Google歸檔儲存設備、以進一步最佳化成本。 link:concept-cloud-backup-policies.html["深入瞭解可用的 BlueXP 備份與還原原則組態設定"^]。

[role="quick-margin-para"]
image:screenshot_backup_policy_gcp.png["顯示 BlueXP 備份與還原設定的螢幕擷取畫面、可供您選擇備份排程與保留期間。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-5.png["五"] 選取您要備份的磁碟區
[role="quick-margin-para"]
在「Select Volumes（選取磁碟區）」頁面中、使用預設的備份原則來識別要備份的磁碟區。如果您想要將不同的備份原則指派給特定磁碟區、可以建立其他原則、並於稍後套用至磁碟區。



== 需求

請先閱讀下列需求、確定您擁有支援的組態、再開始將內部部署磁碟區備份到Google Cloud儲存設備。

從內部部署ONTAP 的還原系統設定備份到Google Cloud Storage時、您可以使用兩種連線方法。

* 公共連線：ONTAP 使用公有Google端點、直接將該等系統連線至Google Cloud Storage。
* 私有連線：使用VPN或Google Cloud互連、並透過使用私有IP位址的私有Google Access介面路由流量。


下圖顯示*公用連線*方法、以及元件之間需要準備的連線。Connector必須部署在Google Cloud Platform VPC中。

image:diagram_cloud_backup_onprem_gcp_public.png["顯示 BlueXP 備份與還原如何透過公共連線與叢集上的磁碟區和備份檔案所在的 Google Cloud 儲存設備進行通訊的圖表。"]

下圖顯示*私有連線*方法、以及元件之間需要準備的連線。Connector必須部署在Google Cloud Platform VPC中。

image:diagram_cloud_backup_onprem_gcp_private.png["顯示 BlueXP 備份與還原如何透過私有連線與叢集上的磁碟區和備份檔案所在的 Google Cloud 儲存設備進行通訊的圖表。"]



=== 準備 ONTAP 您的叢集

您必須先在ONTAP BlueXP中探索內部部署的叢集、才能開始備份大量資料。

https://docs.netapp.com/us-en/cloud-manager-ontap-onprem/task-discovering-ontap.html["瞭解如何探索叢集"^]。

需求 ONTAP::
+
--
* 最低ONTAP 版本為0、9、75；ONTAP 建議使用0、8P13及更新版本。
* SnapMirror授權（包含在優質產品組合或資料保護產品組合中）。
+
* 附註： * 使用 BlueXP 備份與還原時、不需要「混合雲套裝組合」。

+
瞭解如何操作 https://docs.netapp.com/us-en/ontap/system-admin/manage-licenses-concept.html["管理叢集授權"^]。

* 時間和時區設定正確。
+
瞭解如何操作 https://docs.netapp.com/us-en/ontap/system-admin/manage-cluster-time-concept.html["設定叢集時間"^]。



--
叢集網路連線需求::
+
--
* 透過連接埠443從叢集間LIF啟動HTTPS連線至Google Cloud儲存設備、以便進行備份與還原作業。ONTAP
+
可在物件儲存設備中讀取及寫入資料。 ONTAP物件儲存設備從未啟動、只是回應而已。

* 需要連接器與叢集管理LIF之間的傳入連線。ONTAPConnector可位於Google Cloud Platform VPC中。
* 裝載您要備份之磁碟區的 ONTAP 每個節點都需要叢集間 LIF 。LIF 必須與 _IPspac__ 建立關聯、 ONTAP 以便連接物件儲存設備。 https://docs.netapp.com/us-en/ontap/networking/standard_properties_of_ipspaces.html["深入瞭解 IPspaces"^]。
+
當您設定 BlueXP 備份與還原時、系統會提示您輸入要使用的 IPspace 。您應該選擇每個 LIF 所關聯的 IPspace 。這可能是您建立的「預設」 IPspace 或自訂 IPspace 。

* 節點的叢集間生命體能夠存取物件存放區。
* DNS伺服器已針對磁碟區所在的儲存VM進行設定。瞭解如何操作 https://docs.netapp.com/us-en/ontap/networking/configure_dns_services_auto.html["設定SVM的DNS服務"^]。
+
如果您使用的是私有Google存取或私有服務連線、請確定DNS伺服器已設定為指向 `storage.googleapis.com` 至正確的內部（私有）IP位址。

* 請注意、如果您使用的IPspace與預設值不同、則可能需要建立靜態路由才能存取物件儲存設備。
* 如有必要、請更新防火牆規則、以允許 BlueXP 透過連接埠 443 從 ONTAP 備份與還原連線到物件儲存區、以及透過連接埠 53 （ TCP/UDP ）從儲存 VM 到 DNS 伺服器的名稱解析流量。


--




=== 建立或切換連接器

如果您的Google Cloud Platform VPC中已部署Connector、您就能輕鬆完成所有設定。如果沒有、您需要在該位置建立Connector、以便將ONTAP 還原資料備份到Google Cloud儲存設備。您無法使用部署在其他雲端供應商或內部部署的Connector。

* https://docs.netapp.com/us-en/cloud-manager-setup-admin/concept-connectors.html["深入瞭解連接器"^]
* https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-quick-start-connector-google.html["在GCP中安裝連接器"^]




=== 為連接器準備網路

確認連接器具備所需的網路連線。

.步驟
. 確保安裝 Connector 的網路啟用下列連線：
+
** 透過連接埠 443 連接到 BlueXP 備份與恢復服務、以及 Google Cloud 儲存設備的 HTTPS 連線 (https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-set-up-networking-google.html#endpoints-contacted-for-day-to-day-operations["請參閱端點清單"^]）
** 透過連接埠443連線至ONTAP 您的SURF叢 集管理LIF的HTTPS連線


. 在您打算部署Connector的子網路上啟用私有Google Access（或Private Service Connect）。 https://cloud.google.com/vpc/docs/configure-private-google-access["私有 Google 存取"^] 或 https://cloud.google.com/vpc/docs/configure-private-service-connect-apis#on-premises["私有服務連線"^] 如果ONTAP 您從某個叢集直接連線至VPC、而且想要連接器與Google Cloud Storage之間的通訊保持在虛擬私有網路（*私有*連線）中、就需要使用此功能。
+
請依照Google指示設定這些私人存取選項。請確定DNS伺服器已設定為指向 `www.googleapis.com` 和 `storage.googleapis.com` 至正確的內部（私有）IP位址。





=== 驗證或新增連接器權限

若要使用 BlueXP 備份與還原「搜尋與還原」功能、您必須擁有 Connector 角色的特定權限、才能存取 Google Cloud BigQuery 服務。請參閱下列權限、如果您需要修改原則、請遵循這些步驟。

.步驟
. 在中 https://console.cloud.google.com["Google Cloud Console"^]請移至*角色*頁面。
. 使用頁面頂端的下拉式清單、選取包含您要編輯之角色的專案或組織。
. 按一下自訂角色。
. 按一下*編輯角色*以更新角色的權限。
. 按一下「*新增權限*」、將下列新權限新增至角色。
+
[source, json]
----
bigquery.jobs.get
bigquery.jobs.list
bigquery.jobs.listAll
bigquery.datasets.create
bigquery.datasets.get
bigquery.jobs.create
bigquery.tables.get
bigquery.tables.getData
bigquery.tables.list
bigquery.tables.create
----
. 按一下「*更新*」以儲存編輯過的角色。




=== 準備Google Cloud Storage進行備份

設定備份時、您必須為具有特定權限的服務帳戶提供儲存存取金鑰。服務帳戶可讓 BlueXP 備份與還原驗證及存取用於儲存備份的 Cloud Storage 貯體。這些金鑰是必要的、以便 Google Cloud Storage 知道誰在提出要求。

.步驟
. 在中 https://console.cloud.google.com["Google Cloud Console"^]請移至*角色*頁面。
. https://cloud.google.com/iam/docs/creating-custom-roles#creating_a_custom_role["建立新角色"^] 具備下列權限：
+
[source, json]
----
storage.buckets.create
storage.buckets.delete
storage.buckets.get
storage.buckets.list
storage.buckets.update
storage.buckets.getIamPolicy
storage.multipartUploads.create
storage.objects.create
storage.objects.delete
storage.objects.get
storage.objects.list
storage.objects.update
----
. 在Google Cloud主控台中、 https://console.cloud.google.com/iam-admin/serviceaccounts["前往「服務帳戶」頁面"^]。
. 選擇您的雲端專案。
. 按一下*建立服務帳戶*、並提供必要資訊：
+
.. *服務帳戶詳細資料*：輸入名稱和說明。
.. *授予此服務帳戶專案存取權*：選取您剛建立的自訂角色。
.. 按一下「 * 完成 * 」。


. 前往 https://console.cloud.google.com/storage/settings["GCP 儲存設定"^] 並建立服務帳戶的存取金鑰：
+
.. 選取專案、然後按一下 * 互通性 * 。如果您尚未啟用、請按一下 * 「啟用互通性存取」 * 。
.. 在 * 服務帳戶的存取金鑰 * 下、按一下 * 建立服務帳戶的金鑰 * 、選取您剛建立的服務帳戶、然後按一下 * 建立金鑰 * 。
+
稍後當您設定備份服務時、您需要在 BlueXP 備份與還原中輸入金鑰。







==== 使用客戶管理的加密金鑰（CMEK）

您可以使用自己的客戶管理金鑰進行資料加密、而非使用預設的Google管理加密金鑰。在這種情況下、您必須擁有金鑰環和金鑰名稱、才能在啟動精靈中新增此資訊。 https://cloud.google.com/kms/docs/cmek["深入瞭解客戶管理的加密金鑰"^]。

您也需要在Connector for CCMEK角色中新增這些必要權限、才能正常運作：

[source, json]
----
cloudkms.cryptoKeys.get
cloudkms.cryptoKeys.getIamPolicy
cloudkms.cryptoKeys.list
cloudkms.cryptoKeys.setIamPolicy
cloudkms.keyRings.get
cloudkms.keyRings.getIamPolicy
cloudkms.keyRings.list
cloudkms.keyRings.setIamPolicy
----
* CMEK注意事項：*

* 同時支援HSM（硬體備份）和軟體產生的金鑰。
* 同時支援新建立或匯入的雲端KMS金鑰。
* 僅支援區域金鑰、不支援全域金鑰。
* 目前僅支援「對稱加密/解密」用途。
* 與儲存帳戶相關聯的服務代理程式會透過 BlueXP 備份與還原指派「 CryptoKey Encrypter/Decypter （角色 / 雲端 kms.cryptoKeyEncrypterDecypter ）」 IAM 角色。




=== 驗證授權需求

* 您必須先從 Google 訂閱隨用隨付（ PAYGO ） BlueXP Marketplace 產品、或購買並啟動 NetApp 的 BlueXP 備份與恢復 BYOL 授權、才能啟動叢集的 BlueXP 備份與還原。這些授權適用於您的帳戶、可在多個系統上使用。
+
** 如需 BlueXP 備份與還原 PAYGO 授權、您需要訂閱 https://console.cloud.google.com/marketplace/details/netapp-cloudmanager/cloud-manager?supportedpurview=project["Google"^] BlueXP Marketplace 提供使用 BlueXP 備份與還原的方案。BlueXP 備份與還原的帳單是透過此訂閱完成。
** 對於 BlueXP 備份與恢復 BYOL 授權、您需要 NetApp 的序號、以便在授權期間和容量內使用服務。 link:task-licensing-cloud-backup.html#use-a-bluexp-backup-and-recovery-byol-license["瞭解如何管理BYOL授權"]。


* 您必須訂閱Google的物件儲存空間、才能找到備份所在的位置。
+
您可以從內部部署系統建立備份、並在所有地區建立Google Cloud Storage https://cloud.netapp.com/cloud-volumes-global-regions["支援的地方 Cloud Volumes ONTAP"^]。您可以指定在設定服務時儲存備份的區域。





== 啟用 BlueXP 備份與還原

隨時直接從內部部署工作環境啟用 BlueXP 備份與還原。

.步驟
. 從「畫版」中選取工作環境、然後按一下右窗格中「備份與還原」服務旁的*「啟用」>「備份磁碟區」*。
+
如果備份的Google Cloud Storage目的地是在Canvas上作為工作環境存在、您可以將叢集拖曳至Google Cloud Storage工作環境、以啟動設定精靈。

+
image:screenshot_backup_onprem_enable.png["螢幕擷取畫面顯示「啟用備份與還原」按鈕、可在您選取工作環境之後使用。"]

. 選擇Google Cloud做為您的供應商、然後按一下*「下一步*」。
. 輸入供應商詳細資料、然後按*下一步*。
+
.. 您想要在其中建立Google Cloud Storage儲存庫以進行備份的Google Cloud Project。（專案必須擁有具有特定權限的自訂角色的服務帳戶： <<準備Google Cloud Storage進行備份,如此處所述>>）
.. 用於儲存備份的Google存取金鑰和秘密金鑰。
.. 儲存備份的Google區域。
.. 您要備份的磁碟區所在的叢集中的 IPspace ONTAP 。此IPspace的叢集間生命體必須具有傳出網際網路存取。
.. 無論您是使用預設的Google管理加密金鑰、還是選擇自己的客戶管理金鑰來管理資料加密。若要使用CMEK、您必須擁有金鑰環和金鑰名稱。 https://cloud.google.com/kms/docs/cmek["深入瞭解客戶管理的加密金鑰"^]。
+
image:screenshot_backup_onprem_to_google.png["此螢幕快照顯示將磁碟區從內部部署叢集備份到Google Cloud Storage時、雲端供應商的詳細資料。"]



. 如果您的帳戶沒有現有的 BlueXP 備份與還原授權、此時系統會提示您選擇要使用的充電方法類型。您可以從 Google 訂閱隨用隨付（ PAYGO ） BlueXP Marketplace 產品（或如果您有多個訂閱、則需要選擇一個）、或是從 NetApp 購買並啟動 BlueXP 備份與恢復 BYOL 授權。 link:task-licensing-cloud-backup.html["瞭解如何設定 BlueXP 備份與還原授權。"]
. 輸入將用於預設原則的備份原則詳細資料、然後按一下「*下一步*」。您可以選取現有的原則、也可以在每個區段中輸入您的選擇來建立新原則：
+
.. 輸入預設原則的名稱。您不需要變更名稱。
.. 定義備份排程、並選擇要保留的備份數量。 link:concept-ontap-backup-to-cloud.html#customizable-backup-schedule-and-retention-settings["請參閱您可以選擇的現有原則清單"^]。
.. 若使用ONTAP 的是《支援資料》9.12.1或更新版本、您可以選擇在特定天數後將備份分層歸檔至「歸檔」儲存設備、以進一步最佳化成本。 link:concept-cloud-backup-policies.html["深入瞭解可用的 BlueXP 備份與還原原則組態設定"^]。
+
image:screenshot_backup_policy_gcp.png["顯示 BlueXP 備份與還原設定的螢幕擷取畫面、可供您選擇備份排程與保留期間。"]



. 在「Select Volumes（選取磁碟區）」頁面中、使用定義的備份原則選取您要備份的磁碟區。如果您想要將不同的備份原則指派給特定磁碟區、可以建立其他原則、並於稍後將其套用至這些磁碟區。
+
** 若要備份未來新增的所有現有磁碟區和任何磁碟區、請勾選「備份所有現有和未來的磁碟區...」方塊。我們建議您使用此選項、以便備份所有的磁碟區、而且您永遠不需要記住為新的磁碟區啟用備份。
** 若要僅備份現有磁碟區、請勾選標題列中的方塊（image:button_backup_all_volumes.png[""]）。
** 若要備份個別磁碟區、請勾選每個磁碟區的方塊（image:button_backup_1_volume.png[""]）。
+
image:screenshot_backup_select_volumes.png["選取要備份之磁碟區的快照。"]

** 如果此工作環境中有任何讀寫磁碟區的本機Snapshot複本符合您剛才為此工作環境所選取的備份排程標籤（例如每日、每週等）、則會顯示另一個提示：「Export existing Snapshot copies to object storage as Backup copies（匯出現有的Snapshot複本至物件儲存區做為備份複本）」。如果您想要將所有歷史Snapshot複製到物件儲存設備做為備份檔案、以確保為磁碟區提供最完整的保護、請勾選此方塊。


. 按一下 * 啟動備份 * 、然後 BlueXP 備份與還原就會開始為您的磁碟區進行初始備份。


.結果
Google Cloud Storage儲存庫會自動在您輸入的Google存取金鑰和秘密金鑰所指示的服務帳戶中建立、並儲存備份檔案。Volume Backup Dashboard隨即顯示、以便您監控備份狀態。您也可以使用監控備份與還原工作的狀態 link:task-monitor-backup-jobs.html["「工作監控」面板"^]。



== 接下來呢？

* 您可以 link:task-manage-backups-ontap.html["管理備份檔案與備份原則"^]。這包括開始和停止備份、刪除備份、新增和變更備份排程等。
* 您可以 link:task-manage-backup-settings-ontap.html["管理叢集層級的備份設定"^]。這包括變更ONTAP 用來存取雲端儲存設備的儲存金鑰、變更可將備份上傳至物件儲存設備的網路頻寬、變更未來磁碟區的自動備份設定等。
* 您也可以 link:task-restore-backups-ontap.html["從備份檔案還原磁碟區、資料夾或個別檔案"^] 至Cloud Volumes ONTAP Google的某個系統、或內部部署ONTAP 的某個系統。

